<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Generate custom QR codes with logos and branding">
<title>QR Code Generator - Create Custom QR Codes</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

@keyframes gradientShift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
}

.container { 
    max-width: 1200px;
    margin: 40px auto;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 0;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
    overflow: hidden;
    position: relative;
}

header { 
    text-align: center;
    padding: 48px 32px;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    position: relative;
    overflow: hidden;
}

header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    animation: headerPulse 8s ease-in-out infinite;
}

@keyframes headerPulse {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(10%, 10%); }
}

header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 8px;
    position: relative;
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
}

.content { 
    display: flex;
    flex-wrap: wrap;
    gap: 32px;
    padding: 40px;
}

.input-section, .output-section { 
    flex: 1;
    min-width: 320px;
    padding: 32px;
    border-radius: 16px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.input-section {
    background: linear-gradient(135deg, #f6f8ff 0%, #f0f4ff 100%);
    border: 2px solid transparent;
    background-clip: padding-box;
    position: relative;
}

.input-section::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 16px;
    padding: 2px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
}

.output-section {
    background: linear-gradient(135deg, #fff5f7 0%, #fff0f5 100%);
    border: 2px solid transparent;
    position: relative;
}

.output-section::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 16px;
    padding: 2px;
    background: linear-gradient(135deg, #f093fb, #f5576c);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    pointer-events: none;
}

.input-section:hover, .output-section:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

h2 { 
    margin-bottom: 24px;
    font-size: 1.75rem;
    font-weight: 600;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.output-section h2 {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #4a5568;
    font-size: 0.95rem;
}

.input-group {
    margin-bottom: 20px;
}

.input-hint {
    font-size: 0.85rem;
    color: #718096;
    margin-top: 4px;
}

.input-error {
    font-size: 0.85rem;
    color: #e53e3e;
    margin-top: 4px;
    display: none;
}

input, textarea { 
    width: 100%;
    padding: 14px 16px;
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    font-family: inherit;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

input.error, textarea.error {
    border-color: #e53e3e;
    background: #fff5f5;
}

input[type="file"] {
    padding: 12px;
    cursor: pointer;
}

input[type="file"]::file-selector-button {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    cursor: pointer;
    margin-right: 12px;
    transition: all 0.3s ease;
}

input[type="file"]::file-selector-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

input:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

textarea {
    resize: vertical;
    min-height: 100px;
}

button { 
    padding: 14px 28px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    margin: 8px 8px 8px 0;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
}

button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

button:hover:not(:disabled)::before {
    width: 300px;
    height: 300px;
}

button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

button:active:not(:disabled) {
    transform: translateY(0);
}

button:disabled {
    transform: none;
    cursor: not-allowed;
    opacity: 0.6;
}

button:focus-visible {
    outline: 3px solid #667eea;
    outline-offset: 2px;
}

#generate-btn { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

#download-btn { 
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

#download-btn:disabled { 
    background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.qr-container { 
    margin: 24px 0;
    padding: 32px;
    border: 3px dashed #e2e8f0;
    border-radius: 16px;
    background: white;
    transition: all 0.3s ease;
    position: relative;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qr-container:hover {
    border-color: #f093fb;
    box-shadow: 0 8px 16px rgba(240, 147, 251, 0.2);
}

.qr-container img { 
    max-width: 100%;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.qr-container p {
    color: #a0aec0;
    font-size: 1.1rem;
}

.console { 
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    font-family: 'Fira Code', 'Courier New', monospace;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) inset;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 24px;
}

.console::-webkit-scrollbar {
    width: 8px;
}

.console::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.console::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}

.console-line { 
    margin-bottom: 8px;
    font-size: 0.9rem;
    line-height: 1.5;
}

.info { color: #4facfe; }
.error { color: #ff6b9d; }
.success { color: #5eead4; }
.warning { color: #fbbf24; }

.status { 
    padding: 16px 20px;
    border-radius: 12px;
    margin-top: 16px;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    animation: slideIn 0.4s ease;
    text-align: center;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status.success { 
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 2px solid #34d399;
}

.status.error { 
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border: 2px solid #f87171;
}

.status.info {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 2px solid #60a5fa;
}

.status.warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 2px solid #fbbf24;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

@media (max-width: 768px) {
    .container {
        margin: 20px;
    }

    .content {
        padding: 24px;
        gap: 24px;
    }

    header h1 {
        font-size: 2rem;
    }

    .input-section, .output-section {
        padding: 24px;
    }
}
</style>
</head>
<body>
<div class="container">
<header>
    <h1>✨ QR Code Generator</h1>
    <p>Create secure, custom QR codes with optional branding</p>
</header>

<div class="content">
<div class="input-section">
<h2>⚙️ QR Code Settings</h2>

<form id="qr-form" novalidate>
    <div class="input-group">
        <label for="qr-content">Content <span style="color:#e53e3e;">*</span></label>
        <textarea 
            id="qr-content" 
            placeholder="Enter URL or text to encode" 
            rows="3" 
            required
            aria-describedby="content-hint content-error"
            maxlength="2000"
        >https://example.com</textarea>
        <div class="input-hint" id="content-hint">Maximum 2000 characters</div>
        <div class="input-error" id="content-error" role="alert"></div>
    </div>

    <div class="input-group">
        <label for="qr-owner">Owner Name</label>
        <input 
            type="text" 
            id="qr-owner" 
            placeholder="Optional: Your name or company"
            aria-describedby="owner-hint"
            maxlength="100"
        >
        <div class="input-hint" id="owner-hint">Will be embedded in QR metadata</div>
    </div>

    <div class="input-group">
        <label for="qr-title">Title</label>
        <input 
            type="text" 
            id="qr-title" 
            placeholder="Optional: QR code title"
            aria-describedby="title-hint"
            maxlength="100"
        >
        <div class="input-hint" id="title-hint">Descriptive title for your QR code</div>
    </div>

    <div class="input-group">
        <label for="qr-logo">Logo Image</label>
        <input 
            type="file" 
            id="qr-logo" 
            accept="image/png,image/jpeg,image/jpg,image/webp"
            aria-describedby="logo-hint logo-error"
        >
        <div class="input-hint" id="logo-hint">PNG, JPG, or WebP. Max 5MB</div>
        <div class="input-error" id="logo-error" role="alert"></div>
    </div>

    <button type="submit" id="generate-btn" aria-label="Generate QR Code">
        Generate QR Code
    </button>
    <button type="button" id="download-btn" disabled aria-label="Download QR Code">
        Download QR Code
    </button>
</form>

<div class="status info" id="connection-status" role="status" aria-live="polite">
    🔌 Ready to connect
</div>
</div>

<div class="output-section">
<h2>🎨 Your QR Code</h2>
<div class="qr-container" id="qrcode" role="img" aria-label="Generated QR Code">
    <p>QR Code will appear here</p>
</div>
<h2>📋 Console</h2>
<div class="console" id="console" role="log" aria-live="polite" aria-atomic="false"></div>
</div>
</div>
</div>

<script>
// Configuration
const CONFIG = {
    API_URL: (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
        ? 'http://localhost:5000'
        : (window.API_ENDPOINT || 'https://api.yourproduction.com'),
    MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
    REQUEST_TIMEOUT: 30000, // 30 seconds
    MAX_RETRIES: 3,
    VALID_URL_PATTERN: /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/
};

// DOM Elements
const contentEl = document.getElementById('qr-content');
const ownerEl = document.getElementById('qr-owner');
const titleEl = document.getElementById('qr-title');
const logoEl = document.getElementById('qr-logo');
const generateBtn = document.getElementById('generate-btn');
const downloadBtn = document.getElementById('download-btn');
const qrcodeDiv = document.getElementById('qrcode');
const consoleDiv = document.getElementById('console');
const connectionStatus = document.getElementById('connection-status');
const qrForm = document.getElementById('qr-form');

// State
let currentQRImage = null;
let requestController = null;

// Utility Functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addConsole(msg, type = 'info') {
    const line = document.createElement('div');
    line.className = `console-line ${type}`;
    const timestamp = new Date().toLocaleTimeString();
    line.textContent = `[${timestamp}] ${msg}`;
    consoleDiv.appendChild(line);
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
    
    // Keep console from growing too large
    while (consoleDiv.children.length > 50) {
        consoleDiv.removeChild(consoleDiv.firstChild);
    }
}

function showError(inputEl, errorElId, message) {
    const errorEl = document.getElementById(errorElId);
    inputEl.classList.add('error');
    inputEl.setAttribute('aria-invalid', 'true');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
}

function clearError(inputEl, errorElId) {
    const errorEl = document.getElementById(errorElId);
    inputEl.classList.remove('error');
    inputEl.setAttribute('aria-invalid', 'false');
    errorEl.textContent = '';
    errorEl.style.display = 'none';
}

function validateContent(content) {
    if (!content || content.trim().length === 0) {
        return { valid: false, error: 'Content is required' };
    }
    if (content.length > 2000) {
        return { valid: false, error: 'Content exceeds maximum length of 2000 characters' };
    }
    return { valid: true };
}

function validateURL(url) {
    try {
        new URL(url);
        return true;
    } catch {
        return CONFIG.VALID_URL_PATTERN.test(url);
    }
}

function validateFile(file) {
    if (!file) return { valid: true };
    
    const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        return { valid: false, error: 'Please upload a PNG, JPG, or WebP image' };
    }
    
    if (file.size > CONFIG.MAX_FILE_SIZE) {
        return { valid: false, error: 'File size must be less than 5MB' };
    }
    
    return { valid: true };
}

function setButtonLoading(button, isLoading, loadingText) {
    if (isLoading) {
        button.dataset.originalText = button.textContent;
        button.innerHTML = `<span class="spinner"></span>${loadingText}`;
        button.disabled = true;
    } else {
        button.textContent = button.dataset.originalText || button.textContent;
        button.disabled = false;
    }
}

function updateConnectionStatus(status, message) {
    connectionStatus.className = `status ${status}`;
    const icons = {
        success: '✓',
        error: '✗',
        warning: '⚠',
        info: '🔌'
    };
    connectionStatus.textContent = `${icons[status]} ${message}`;
}

async function fetchWithTimeout(url, options, timeout = CONFIG.REQUEST_TIMEOUT) {
    requestController = new AbortController();
    const timeoutId = setTimeout(() => requestController.abort(), timeout);
    
    try {
        const response = await fetch(url, {
            ...options,
            signal: requestController.signal
        });
        clearTimeout(timeoutId);
        return response;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

async function generateQRWithRetry(formData, retries = CONFIG.MAX_RETRIES) {
    for (let i = 0; i < retries; i++) {
        try {
            addConsole(`Attempt ${i + 1}/${retries}: Sending request...`, 'info');
            
            const response = await fetchWithTimeout(
                `${CONFIG.API_URL}/generate-qr`,
                { method: 'POST', body: formData }
            );
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data;
            
        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('Request timed out. Please try again.');
            }
            
            if (i === retries - 1) throw error;
            
            const delay = Math.min(1000 * Math.pow(2, i), 5000);
            addConsole(`Retry in ${delay}ms...`, 'warning');
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

// Event Handlers
contentEl.addEventListener('input', () => {
    clearError(contentEl, 'content-error');
});

logoEl.addEventListener('change', () => {
    clearError(logoEl, 'logo-error');
    const file = logoEl.files[0];
    if (file) {
        const validation = validateFile(file);
        if (!validation.valid) {
            showError(logoEl, 'logo-error', validation.error);
            logoEl.value = '';
        }
    }
});

qrForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous errors
    clearError(contentEl, 'content-error');
    clearError(logoEl, 'logo-error');
    
    // Validate inputs
    const content = contentEl.value.trim();
    const contentValidation = validateContent(content);
    
    if (!contentValidation.valid) {
        showError(contentEl, 'content-error', contentValidation.error);
        addConsole('Validation failed: ' + contentValidation.error, 'error');
        contentEl.focus();
        return;
    }
    
    const logo = logoEl.files[0];
    const fileValidation = validateFile(logo);
    
    if (!fileValidation.valid) {
        showError(logoEl, 'logo-error', fileValidation.error);
        addConsole('Validation failed: ' + fileValidation.error, 'error');
        return;
    }
    
    // Prepare form data
    const formData = new FormData();
    formData.append('content', content);
    formData.append('owner', ownerEl.value.trim());
    formData.append('title', titleEl.value.trim());
    if (logo) {
        formData.append('logo', logo);
        addConsole(`Logo attached: ${escapeHtml(logo.name)} (${(logo.size / 1024).toFixed(1)}KB)`, 'info');
    }
    
    // UI updates
    qrcodeDiv.innerHTML = '<p style="color:#667eea;">🔄 Generating your QR code...</p>';
    setButtonLoading(generateBtn, true, 'Generating...');
    downloadBtn.disabled = true;
    currentQRImage = null;
    
    try {
        const data = await generateQRWithRetry(formData);
        
        if (data.success) {
            addConsole('✓ QR code generated successfully', 'success');
            
            const img = document.createElement('img');
            img.src = data.image_url + '?t=' + new Date().getTime();
            img.alt = 'Generated QR Code for: ' + content;
            img.onload = () => {
                qrcodeDiv.innerHTML = '';
                qrcodeDiv.appendChild(img);
                currentQRImage = img.src;
                downloadBtn.disabled = false;
                updateConnectionStatus('success', 'Connected to backend');
                addConsole('QR code ready for download', 'success');
            };
            img.onerror = () => {
                throw new Error('Failed to load generated QR code image');
            };
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
        
    } catch (err) {
        const errorMsg = err.message || 'Network error occurred';
        addConsole('✗ Error: ' + errorMsg, 'error');
        updateConnectionStatus('error', 'Backend connection failed');
        qrcodeDiv.innerHTML = `<p style="color:#ff6b9d;">⚠ ${escapeHtml(errorMsg)}<br><small>Make sure the backend server is running on ${CONFIG.API_URL}</small></p>`;
        
    } finally {
        setButtonLoading(generateBtn, false, 'Generate QR Code');
    }
});

downloadBtn.addEventListener('click', function() {
    if (!currentQRImage) {
        addConsole('No QR code available to download', 'warning');
        return;
    }
    
    try {
        const link = document.createElement('a');
        link.href = currentQRImage;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        link.download = `qrcode-${timestamp}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        addConsole('✓ QR code downloaded successfully', 'success');
    } catch (err) {
        addConsole('✗ Download failed: ' + err.message, 'error');
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        if (!generateBtn.disabled) {
            qrForm.dispatchEvent(new Event('submit'));
        }
    }
});

// Initialize
addConsole('System initialized', 'success');
addConsole('Ready to generate QR codes', 'info');
addConsole(`Backend URL: ${CONFIG.API_URL}`, 'info');
updateConnectionStatus('info', 'Ready to connect');

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (requestController) {
        requestController.abort();
    }
});
</script>
</body>
</html>